<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô EcoPoint</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;700&display=swap');
        * { font-family: 'Sarabun', sans-serif; }
    </style>
</head>
<body class="bg-gradient-to-br from-green-50 to-blue-50 min-h-screen">
    <div id="app"></div>

    <script>
        // --- 2. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ (Firebase Config) ---
        const firebaseConfig = {
            databaseURL: "https://eco-point309-default-rtdb.asia-southeast1.firebasedatabase.app/"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const trashTypes = [
            { id: 1, name: '‡∏Ç‡∏ß‡∏î‡πÉ‡∏´‡∏ç‡πà', points: 10, icon: 'üçæ' },
            { id: 2, name: '‡∏Ç‡∏ß‡∏î‡πÄ‡∏•‡πá‡∏Å', points: 5, icon: 'üß¥' }
        ];

        const rewards = [
            { id: 1, name: '‡∏õ‡∏≤‡∏Å‡∏Å‡∏≤', points: 50, icon: '‚úèÔ∏è' },
            { id: 2, name: '‡∏™‡∏°‡∏∏‡∏î‡πÇ‡∏ô‡πâ‡∏ï', points: 100, icon: 'üìì' },
            { id: 3, name: '‡∏Ç‡∏ô‡∏°', points: 30, icon: 'üç´' },
            { id: 4, name: '‡∏Ç‡∏≠‡∏á‡πÄ‡∏•‡πà‡∏ô', points: 200, icon: 'üéÆ' },
            { id: 5, name: '‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô', points: 500, icon: 'üëï' }
        ];

        const ADMIN_USERNAME = 'admin';
        const ADMIN_PASSWORD = 'admin123';

        let currentUser = null;
        let isAdmin = false;
        let users = [];
        let transactions = [];
        let currentPage = 'home';
        let editingUser = null;
        let searchQuery = '';
        let showRegister = false;

        // --- 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå (‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà LocalStorage ‡πÄ‡∏î‡∏¥‡∏°) ---
        function loadDataOnline() {
            db.ref('ecopoint_data').on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    users = data.users || [];
                    transactions = data.transactions || [];
                }
                render(); 
            });
        }

        function saveData() {
            db.ref('ecopoint_data').set({
                users: users,
                transactions: transactions
            });
        }

        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        loadDataOnline();

        // --- 4. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ï‡πà‡∏≤‡∏á‡πÜ (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ï‡πà‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å saveData ‡πÉ‡∏´‡∏°‡πà) ---
        function handleStudentLogin() {
            const studentId = document.getElementById('login-id').value.trim();
            const password = document.getElementById('login-password').value.trim();
            if (!studentId || !password) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô'); return; }

            let user = users.find(u => u.studentId === studentId);
            if (!user) { alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö'); return; }
            if (user.password !== password) { alert('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'); return; }
            
            currentUser = user;
            currentPage = 'profile';
            render();
        }

        function handleStudentRegister() {
            const name = document.getElementById('register-name').value.trim();
            const studentId = document.getElementById('register-id').value.trim();
            const password = document.getElementById('register-password').value.trim();
            const confirmPassword = document.getElementById('register-confirm-password').value.trim();
            
            if (!name || !studentId || !password || !confirmPassword) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô'); return; }
            if (password !== confirmPassword) { alert('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô'); return; }
            if (users.find(u => u.studentId === studentId)) { alert('‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß'); return; }

            const newUser = {
                id: Date.now(),
                name: name,
                studentId: studentId,
                password: password,
                points: 0,
                totalTrash: 0,
                createdAt: new Date().toISOString()
            };
            
            users.push(newUser);
            saveData();
            alert('‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
            switchTab('login');
        }

        function handleAdminLogin() {
            const username = document.getElementById('admin-username').value.trim();
            const password = document.getElementById('admin-password').value.trim();
            if (username === ADMIN_USERNAME && password === ADMIN_PASSWORD) {
                isAdmin = true;
                currentPage = 'admin-dashboard';
                render();
            } else { alert('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'); }
        }

        function handleLogout() {
            currentUser = null;
            isAdmin = false;
            currentPage = 'home';
            render();
        }

        function submitAdminExchange() {
            const trashId = document.getElementById('admin-trash-type').value;
            const weight = parseFloat(document.getElementById('admin-weight').value);
            if (!trashId || !weight || weight <= 0) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'); return; }

            const trashType = trashTypes.find(t => t.id === parseInt(trashId));
            const pointsEarned = Math.floor(trashType.points * weight);
            
            users = users.map(u => u.id === editingUser.id ? { ...u, points: u.points + pointsEarned, totalTrash: u.totalTrash + weight } : u);
            transactions.push({
                id: Date.now(),
                userId: editingUser.id,
                userName: editingUser.name,
                trashType: trashType.name,
                weight: weight,
                points: pointsEarned,
                date: new Date().toISOString()
            });

            saveData();
            alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!');
            currentPage = 'admin-dashboard';
            render();
        }

        // --- 5. UI Rendering (‡∏¢‡∏Å‡∏¢‡∏≠‡∏î‡∏à‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏°‡∏≤) ---
        function switchTab(tab) {
            render(); // ‡∏™‡∏±‡πà‡∏á‡∏ß‡∏≤‡∏î‡πÉ‡∏´‡∏°‡πà‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ Element ‡πÇ‡∏ú‡∏•‡πà‡∏°‡∏≤
            setTimeout(() => { // ‡∏£‡∏≠‡πÅ‡∏õ‡πä‡∏ö‡∏´‡∏ô‡∏∂‡πà‡∏á‡πÉ‡∏´‡πâ DOM ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï
                const loginForm = document.getElementById('form-login');
                const regForm = document.getElementById('form-register');
                const adminForm = document.getElementById('form-admin');
                if(loginForm) loginForm.style.display = (tab === 'login' ? 'block' : 'none');
                if(regForm) regForm.style.display = (tab === 'register' ? 'block' : 'none');
                if(adminForm) adminForm.style.display = (tab === 'admin' ? 'block' : 'none');
            }, 10);
        }

        function render() {
            const app = document.getElementById('app');
            if (isAdmin) {
                // ‡∏´‡∏ô‡πâ‡∏≤ Admin Dashboard
                app.innerHTML = `
                    <div class="p-4 max-w-4xl mx-auto">
                        <div class="flex justify-between items-center mb-6">
                            <h1 class="text-2xl font-bold">Admin Panel</h1>
                            <button onclick="handleLogout()" class="bg-red-500 text-white px-4 py-2 rounded">‡∏≠‡∏≠‡∏Å</button>
                        </div>
                        <div class="bg-white p-4 rounded shadow mb-6">
                            <h2 class="font-bold mb-4">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (${users.length})</h2>
                            ${users.map(u => `
                                <div class="flex justify-between items-center border-b py-2">
                                    <span>${u.name} (${u.points} ‡πÅ‡∏ï‡πâ‡∏°)</span>
                                    <button onclick="editingUser=users.find(x=>x.id===${u.id}); currentPage='admin-add-points'; render();" class="bg-green-500 text-white px-2 py-1 rounded text-xs">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                if (currentPage === 'admin-add-points') {
                    app.innerHTML = `
                        <div class="p-4 max-w-md mx-auto bg-white rounded shadow">
                            <h2 class="font-bold mb-4">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÉ‡∏´‡πâ: ${editingUser.name}</h2>
                            <select id="admin-trash-type" class="w-full mb-2 p-2 border">
                                ${trashTypes.map(t => `<option value="${t.id}">${t.name}</option>`).join('')}
                            </select>
                            <input type="number" id="admin-weight" placeholder="‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å (‡∏Å‡∏Å.)" class="w-full mb-4 p-2 border">
                            <button onclick="submitAdminExchange()" class="w-full bg-blue-600 text-white py-2 rounded">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                            <button onclick="currentPage='admin-dashboard'; render();" class="w-full mt-2 text-gray-500">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                        </div>
                    `;
                }
            } else if (currentUser) {
                // ‡∏´‡∏ô‡πâ‡∏≤ Profile ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
                app.innerHTML = `
                    <div class="p-6 max-w-md mx-auto bg-white rounded-xl shadow-lg mt-10">
                        <div class="text-center">
                            <div class="text-5xl mb-4">üë§</div>
                            <h2 class="text-2xl font-bold">${currentUser.name}</h2>
                            <p class="text-gray-500">ID: ${currentUser.studentId}</p>
                            <div class="mt-6 bg-green-100 p-4 rounded-lg">
                                <p class="text-green-800 text-sm">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏∞‡∏™‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
                                <p class="text-4xl font-black text-green-600">${currentUser.points}</p>
                                <p class="text-green-800 text-xs mt-1">EcoPoints</p>
                            </div>
                            <button onclick="handleLogout()" class="mt-8 text-red-500 text-sm">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
                        </div>
                    </div>
                `;
            } else {
                // ‡∏´‡∏ô‡πâ‡∏≤ Login / Register
                app.innerHTML = `
                    <div class="max-w-md mx-auto mt-20 p-4">
                        <div class="bg-white rounded-t-xl flex border-b">
                            <button onclick="switchTab('login')" id="tab-login" class="flex-1 py-4 font-bold text-green-600 border-b-2 border-green-600">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
                            <button onclick="switchTab('register')" id="tab-register" class="flex-1 py-4 font-bold text-gray-400">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</button>
                            <button onclick="switchTab('admin')" id="tab-admin" class="flex-1 py-4 font-bold text-gray-400">‡∏Ñ‡∏£‡∏π</button>
                        </div>
                        <div class="bg-white p-6 rounded-b-xl shadow-xl">
                            <div id="form-login">
                                <input id="login-id" type="text" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô" class="w-full mb-4 p-3 border rounded">
                                <input id="login-password" type="password" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" class="w-full mb-4 p-3 border rounded">
                                <button onclick="handleStudentLogin()" class="w-full bg-green-600 text-white py-3 rounded-lg font-bold">‡∏ï‡∏Å‡∏•‡∏á</button>
                            </div>
                            <div id="form-register" style="display:none">
                                <input id="register-name" type="text" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" class="w-full mb-3 p-3 border rounded">
                                <input id="register-id" type="text" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô" class="w-full mb-3 p-3 border rounded">
                                <input id="register-password" type="password" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" class="w-full mb-3 p-3 border rounded">
                                <input id="register-confirm-password" type="password" placeholder="‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" class="w-full mb-3 p-3 border rounded">
                                <button onclick="handleStudentRegister()" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</button>
                            </div>
                            <div id="form-admin" style="display:none">
                                <input id="admin-username" type="text" placeholder="Admin Username" class="w-full mb-4 p-3 border rounded">
                                <input id="admin-password" type="password" placeholder="Admin Password" class="w-full mb-4 p-3 border rounded">
                                <button onclick="handleAdminLogin()" class="w-full bg-purple-600 text-white py-3 rounded-lg font-bold">‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏£‡∏π</button>
                            </div>
                        </div>
                    </div>
                `;
            }
        }
    </script>
</body>
</html>
